<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Books Read per Month</title>
  <link rel="stylesheet" type="text/css" href="styles.css">
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <div class="header">
    <h1>My books</h1>
    <p>All the books read from 2014 to 2024</p>
  </div>
  
  <script>
    function drawChart(year) {
      d3.csv("books.csv").then(function(data) {
        d3.select("#chart").selectAll("*").remove();
        if (!year) return; 

        var filteredData = data.filter(function(d) {
          return d.Year == year;
        });

        var months = d3.range(1, 13); // Generiranje svih mjeseci od 1 do 12

        var booksReadPerMonth = months.map(function(month) {
          return {
            month: month,
            booksRead: filteredData.filter(function(d) {
              return +d.DateRead.split("/")[1] === month; // Provjera ima li podataka za trenutni mjesec
            }).length
          };
        });

        // Dimenzije grafikona
        var margin = { top: 50, right: 50, bottom: 60, left: 50 }, // Povećanje margin.bottom da bi se oznake na x-osi mogle prikazati
            width = 1000 - margin.left - margin.right,
            height = 450 - margin.top - margin.bottom;

        // X i Y skale
        var x = d3.scaleBand()
            .domain(months.map(String)) // Konvertiranje mjeseci u stringove radi prikaza na x-osi
            .range([0, width])
            .padding(0.1);

        var y = d3.scaleLinear()
            .domain([0, d3.max(booksReadPerMonth, function(d) { return d.booksRead; })])
            .nice()
            .range([height, 0]);

        // Kreiranje osi
        var xAxis = d3.axisBottom(x)
          .tickFormat(function(d) {
            // Rotacija oznaka na x-osi
            var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            return monthNames[parseInt(d) - 1]; // Konvertiranje broja mjesta u indeks mjeseca u nizu
          });

        var yAxis = d3.axisLeft(y)
          .ticks(5);

        // Uklanjanje prethodnog grafikona
        d3.select("#chart").selectAll("*").remove();

        // Kreiranje SVG elementa
        var svg = d3.select("#chart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Dodavanje X osi
        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
            .selectAll("text")
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("transform", "rotate(-65)");

        // Dodavanje Y osi
        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis);

        var barchart = svg.selectAll("rect")
          .data(booksReadPerMonth)
          .enter()
          .append("rect")
          .attr("x", function(d) { return x(String(d.month)); })
          .attr("y", function(d) { return y(d.booksRead); })
          .attr("height", function(d) { return height - y(d.booksRead); })
          .attr("width", x.bandwidth())
          .attr("class", function(d) { return "bar bar-" + String(d.month); })
          .on("click", function(d) {
            var clickedMonth = d3.select(this).attr("class").split(" ")[1].split("-")[1]; // Dohvaćamo redni broj mjeseca iz klase
            showBooksByMonth(clickedMonth, year);
          });

        var totalBooks = d3.sum(booksReadPerMonth, function(d) { return d.booksRead; });

        svg.append("text")
        .attr("class", "total-books")
        .attr("x", width / 2)
        .attr("y", "-10px")
        .attr("text-anchor", "middle")
        .text("Total books read: " + totalBooks)
        .attr("font-weight", "600")
        .attr("font-size", "1.4em");
      });
    }

    function drawPieChart(year) {
    d3.csv("books.csv").then(function(data) {
      d3.select("#pie-chart").selectAll("*").remove();
      if (!year) return; 

      var filteredData = data.filter(function(d) {
          return d.Year == year;
      });

      var genreCounts = {};

      filteredData.forEach(function(d) {
          var genres = d.Genre.split(","); // Ako je žanrova više, razdvajamo ih zarezom
          genres.forEach(function(genre) {
              genre = genre.trim(); // Uklanjamo praznine sa početka i kraja stringa
              genreCounts[genre] = (genreCounts[genre] || 0) + 1; // Inkrementiranje brojača za trenutni žanr
          });
      });

      var genreData = Object.keys(genreCounts).map(function(genre) {
          return { genre: genre, count: genreCounts[genre] };
      });

      var totalBooks = genreData.reduce(function(acc, d) { return acc + d.count; }, 0);

      var width = 350,
          height = 250,
          padding = 100,
          radius = Math.min(width, height) / 2;

      var svg = d3.select("#pie-chart")
          .append("svg")
          .attr("width", width + 2*padding)
          .attr("height", height + 2*padding)
          .append("g")
          .attr("transform", "translate(" + (width / 2 + padding) + "," + (height / 2 + padding) + ")");

        genreData.sort(function(a, b) {
            return b.count - a.count;
        });

        var customColors = ['#FAC55A', '#DF832F', '#D2611A', '#C44004', '#9D4410', '#76491C', '#4E4D27', '#275233', '#00563F'];

        var colorMap = {};
        genreData.forEach(function(d, i) {
            colorMap[d.genre] = customColors[i];
        });

        var colorScale = d3.scaleOrdinal()
            .domain(genreData.map(function(d) { return d.genre; }))
            .range(genreData.map(function(d) { return colorMap[d.genre]; }));


        var pie = d3.pie()
            .value(function(d) { return d.count; });

        var arc = d3.arc()
            .innerRadius(0)
            .outerRadius(Math.min(width, height) / 2 - 1);

        var outerArc = d3.arc()
            .innerRadius(radius + 50)
            .outerRadius(radius);

        // Dodavanje pie chart segmenata
        var arcs = svg.selectAll(".arc")
            .data(pie(genreData))
            .enter().append("g")
            .attr("class", "arc");

        var addedPolylineAndText = false;

        arcs.append("path")
            .attr("d", arc)
            .attr("fill", function(d) { return colorScale(d.data.genre); })
            .transition() // Dodajemo tranziciju
            .duration(2000) // Trajanje tranzicije u milisekundama
            .attrTween('d', function(d) {
                var i = d3.interpolate(d.startAngle, d.endAngle);
                return function(t) {
                    d.endAngle = i(t);
                    return arc(d);
                }
            })
            .on("end", function() {
                // Provjeravamo je li već dodan polyline i tekst
                if (!addedPolylineAndText) {
                    // Ako nisu dodani, dodajemo ih
                    arcs.append("polyline")
                        .attr("points", function(d) {
                            var pos = outerArc.centroid(d);
                            pos[0] = radius * 1.08 * (midAngle(d) < Math.PI ? 1 : -1);
                            return [arc.centroid(d), outerArc.centroid(d), pos];
                        })
                        .style("fill", "none")
                        .style("stroke", "black")
                        .style("opacity", 0) // Postavljamo početnu vrijednost opacity na 0
                        .transition() // Dodajemo tranziciju
                        .duration(500) // Trajanje tranzicije u milisekundama
                        .style("opacity", 1); 

                    arcs.append("text")
                        .attr("transform", function(d) {
                            var pos = outerArc.centroid(d);
                            pos[0] = radius * 1.2 * (midAngle(d) < Math.PI ? 1 : -1);
                            return "translate(" + pos + ")";
                        })
                        .attr("dy", ".35em")
                        .style("text-anchor", function(d) {
                            return midAngle(d) < Math.PI ? "start" : "end";
                        })
                        .text(function(d) { return (d.data.genre + ": " + ((d.data.count/totalBooks)*100).toFixed(1) + "%"); })
                        .style("opacity", 0) // Postavljamo početnu vrijednost opacity na 0
                        .transition() // Dodajemo tranziciju
                        .duration(500) // Trajanje tranzicije u milisekundama
                        .style("opacity", 1); 
                    // Postavljamo varijablu na true kako bismo označili da su polyline i tekst dodani
                    addedPolylineAndText = true;
                }
            });

        function midAngle(d) {
            return d.startAngle + (d.endAngle - d.startAngle) / 2;
        }

        svg.append("text")
            .attr("class", "pie-chart")
            .attr("x", "0px")
            .attr("y", "-185px")
            .attr("text-anchor", "middle")
            .text("Genres read:")
            .attr("font-weight", "600")
            .attr("font-size", "1.4em");
    
      });
    }

    function drawDonutChart(year) {
        d3.csv("books.csv").then(function(data) {
            d3.select("#donut-chart").selectAll("*").remove();
            if (!year) return; 

            var filteredData = data.filter(function(d) {
                return d.Year == year;
            });

            var totalBooks = filteredData.length; 

            var goals = {
                    2014: 10,
                    2015: 20, 
                    2016: 30,
                    2017: 30,
                    2018: 30,
                    2019: 30,
                    2020: 30,
                    2021: 30,
                    2022: 30,
                    2023: 30,
                    2024: 30,
                };


            var width = 350,
                height = 350,
                radiusInner = 100,
                radiusOuter = Math.min(width, height) / 2 - 25;

            var dataDonut = [
                { label: "Pročitane", value: 0 },
                { label: "Preostale", value: goals[year] }
            ];

            var dataDonut1 = [
                { label: "Pročitane", value: totalBooks },
                { label: "Preostale", value: goals[year] - totalBooks }
            ];

            var svg = d3.select("#donut-chart")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

            var colorDonut = d3.scaleOrdinal()
                .domain(["Pročitane", "Preostale"])
                .range(["darkseagreen", "#F37433"]);

            var pie = d3.pie()
                .value(function(d) { return d.value; });

            var arc = d3.arc()
                .innerRadius(radiusInner)
                .outerRadius(radiusOuter);

            svg.selectAll("path")
                .data(pie(dataDonut))
                .enter()
                .append("path")
                .attr("d", arc)
                .attr("fill", function(d) { return colorDonut(d.data.label); })
                .transition() // Dodajemo tranziciju
                .duration(2000) // Trajanje tranzicije u milisekundama
                .attrTween('d', function(d) {
                    var i = d3.interpolate(d.startAngle,  d.endAngle);
                    return function(t) {
                        d.endAngle = i(t);
                        return arc(d);
                    }
                });

            svg.selectAll("path")
                .data(pie(dataDonut1))
                .enter()
                .append("path")
                .attr("d", arc)
                .attr("fill", function(d) { return colorDonut(d.data.label); })
                .transition() // Dodajemo tranziciju
                .duration(2000) // Trajanje tranzicije u milisekundama
                .attrTween('d', function(d) {
                    var i = d3.interpolate(d.startAngle+0.1, d.endAngle);
                    return function(t) {
                        d.endAngle = i(t);
                        return arc(d);
                    }
                });

            svg.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "0.35em")
                .text(totalBooks + " / " + goals[year])
                .style("font-size", "60px")
                .style("fill", "#000")
                .style("opacity", 0)
                .transition() // Dodajemo tranziciju
                .delay(2000) 
                .duration(1500) // Trajanje tranzicije u milisekundama
                .style("opacity", 1); 

            svg.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "-2em")
                .text("Reading goal:")
                .style("fill", "#000")
                .attr("class", "donut-chart")
                .attr("font-weight", "600")
                .attr("font-size", "1.4em"); 
        });
    }

    function drawComparisonChart(selectedYears) {

d3.select("#chart").selectAll("*").remove();
d3.select("#pie-chart").selectAll("*").remove();
d3.select("#donut-chart").selectAll("*").remove();
d3.select("#books-div").selectAll("*").remove();
d3.select("#books-div1").selectAll("*").remove();
d3.select("#total-pages").selectAll("*").remove();
if (selectedYears.length === 0) return;

d3.csv("books.csv").then(function(data) {
    var months = d3.range(1, 13);
    var customColors = ['#FAC55A', '#DF832F', '#D2611A', '#C44004', '#9D4410', '#76491C', '#4E4D27', '#275233', '#00563F'];

var colors = d3.scaleOrdinal()
    .domain(selectedYears)
    .range(customColors);
    var booksReadPerMonthByYear = [];

    // Iteriranje kroz svaku odabrane godinu i kreiranje podataka za svaku od njih
    selectedYears.forEach(function(year) {
        var filteredData = data.filter(function(d) {
            return d.Year == year;
        });

        var booksReadPerMonth = months.map(function(month) {
            return {
                month: month,
                booksRead: filteredData.filter(function(d) {
                    return +d.DateRead.split("/")[1] === month;
                }).length
            };
        });

        booksReadPerMonthByYear.push({
            year: year,
            data: booksReadPerMonth
        });
    });

    // Dimenzije grafikona
    var margin = { top: 50, right: 50, bottom: 60, left: 50 },
        width = 1000 - margin.left - margin.right,
        height = 450 - margin.top - margin.bottom;

    // X i Y skale
    var x = d3.scaleBand()
        .domain(months.map(String))
        .range([0, width])
        .padding(0.1);

    var y = d3.scaleLinear()
        .domain([0, d3.max(booksReadPerMonthByYear, function(d) {
            return d3.max(d.data, function(e) {
                return e.booksRead;
            });
        })])
        .nice()
        .range([height, 0]);

    var xAxis = d3.axisBottom(x)
      .tickFormat(function(d) {
            // Rotacija oznaka na x-osi
            var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            return monthNames[parseInt(d) - 1]; // Konvertiranje broja mjesta u indeks mjeseca u nizu
      });

    var yAxis = d3.axisLeft(y)
        .ticks(5);

    // Kreiranje linija za svaku godinu
    var line = d3.line()
        .x(function(d) { return x(String(d.month)) + x.bandwidth() / 2; })
        .y(function(d) { return y(d.booksRead); });

    // Kreiranje SVG elementa
    var svg = d3.select("#chart").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // Tooltip element
    var tooltip = d3.select("#chart").insert("div", ":first-child")
        .attr("class", "tooltip");

    // Dodavanje linija na grafikon
    booksReadPerMonthByYear.forEach(function(yearData) {
        svg.append("path")
            .datum(yearData.data)
            .attr("class", "line")
            .attr("d", line)
            .style("stroke", colors(yearData.year))
            .style("fill", "none")
            .style("stroke-width", "1.5px");

        // Dodavanje točaka (krugova) na linijski graf
        // Dodavanje točaka (krugova) na linijski graf
            svg.selectAll(".dot" + yearData.year)
                .data(yearData.data)
                .enter().append("circle")
                .attr("class", "dot")
                .attr("cx", function(d) { return x(String(d.month)) + x.bandwidth() / 2; })
                .attr("cy", function(d) { return y(d.booksRead); })
                .attr("r", 5)
                .style("fill", colors(yearData.year))
                .style("cursor", "pointer")
                .on("mouseover", function(event, d) {
                    tooltip.html("Books read: " + d.booksRead)
                        .style("visibility", "visible")
                        .style("top", (event.pageY - 10) + "px")
                        .style("left", (event.pageX + 10) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("visibility", "hidden");
                });

    });

    // Dodavanje X osi
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis)
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-65)");

    // Dodavanje Y osi
    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis);

    // Dodavanje legendi
    var legend = svg.selectAll(".legend")
        .data(selectedYears)
        .enter().append("g")
        .attr("class", "legend")
        .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

    legend.append("rect")
        .attr("x", width - 18)
        .attr("width", 18)
        .attr("height", 18)
        .style("fill", function(d) { return colors(d); });

    legend.append("text")
        .attr("x", width - 24)
        .attr("y", 9)
        .attr("dy", ".35em")
        .style("text-anchor", "end")
        .text(function(d) { return d; });

    svg.append("text")
        .attr("x", width / 2)
        .attr("y", "-10px")
        .attr("text-anchor", "middle")  
        .attr("font-weight", "600")
        .attr("font-size", "1.4em")
        .text("Books Read per Month by Year");

    });
}

function drawBooksPieChart(years) {
    d3.csv("books.csv").then(function(data) {
      d3.select("#pie-chart").selectAll("*").remove();
      if (!years.length) return; 

      var booksCountByYear = {};

      years.forEach(function(year) {
          var filteredData = data.filter(function(d) {
              return d.Year == year;
          });
          booksCountByYear[year] = filteredData.length;
      });

      var totalBooks = d3.sum(Object.values(booksCountByYear));

      var width = 300,
          height = 250,
          padding = 100,
          radius = Math.min(width, height) / 2;

      var svg = d3.select("#pie-chart")
          .append("svg")
          .attr("width", width + 2*padding)
          .attr("height", height + 2*padding)
          .append("g")
          .attr("transform", "translate(" + (width / 2 + padding) + "," + (height / 2 + padding) + ")");

        var pie = d3.pie()
            .value(function(d) { return d.value; });

        var arc = d3.arc()
            .innerRadius(0)
            .outerRadius(Math.min(width, height) / 2 - 1);

        var outerArc = d3.arc()
            .innerRadius(radius + 50)
            .outerRadius(radius);

        var genreData = Object.keys(booksCountByYear).map(function(year) {
            return { year: year, value: booksCountByYear[year] };
        });

        var customColors = ['#FAC55A', '#DF832F', '#D2611A', '#C44004', '#9D4410', '#76491C', '#4E4D27', '#275233', '#00563F'];

        var colorScale = d3.scaleOrdinal()
            .domain(genreData.map(function(d) { return d.year; }))
            .range(customColors);

        var arcs = svg.selectAll(".arc")
            .data(pie(genreData))
            .enter().append("g")
            .attr("class", "arc");

            var addedPolylineAndText = false;

        arcs.append("path")
            .attr("d", arc)
            .attr("fill", function(d) { return colorScale(d.data.year); })
            .transition() // Dodajemo tranziciju
            .duration(2000) // Trajanje tranzicije u milisekundama
            .attrTween('d', function(d) {
                var i = d3.interpolate(d.startAngle, d.endAngle);
                return function(t) {
                    d.endAngle = i(t);
                    return arc(d);
                }
            })

        var tooltip = d3.select("#chart").insert("div", ":first-child")
        .attr("class", "tooltip");

        arcs.on("mouseover", function(event, d) { // Dodavanje event listenera za hover
                var percent = ((d.data.value / totalBooks) * 100).toFixed(1);
                tooltip.html(d.data.year + ": " + percent + "%")
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY - 28) + "px")
                    .style("visibility", "visible");
            })
            .on("mouseout", function(d) {
                tooltip.style("visibility", "hidden");
            });

        svg.append("text")
            .attr("class", "pie-chart")
            .attr("x", "0px")
            .attr("y", "-185px")
            .attr("text-anchor", "middle")
            .text("Books read per year:")
            .attr("font-weight", "600")
            .attr("font-size", "1.4em");

        // Dodavanje legende
        var legend = svg.selectAll(".legend")
            .data(genreData)
            .enter().append("g")
            .attr("class", "legend")
            .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

        legend.append("rect")
            .attr("x", width / 2 +10)
            .attr("y", -100)
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", function(d) { return colorScale(d.year); });

        legend.append("text")
            .attr("x", width / 2 + 35)
            .attr("y", -91)
            .attr("dy", ".35em")
            .style("text-anchor", "start")
            .text(function(d) { return d.year; });
    });
}


  function drawStackedHorizontalBarChart(selectedYears) {
    d3.select("#chart").selectAll("*").remove();
    d3.select("#pie-chart").selectAll("*").remove();
    d3.select("#donut-chart").selectAll("*").remove();
    d3.select("#books-div").selectAll("*").remove();
    d3.select("#books-div1").selectAll("*").remove();
    d3.select("#total-pages").selectAll("*").remove();

    if (selectedYears.length === 0) return;

    d3.csv("books.csv").then(function(data) {
        var genres = Array.from(new Set(data.map(d => d.Genre.trim()))); // Dohvaćanje svih žanrova, obrezivanje praznina
        var genreColor = d3.scaleOrdinal(d3.schemeCategory10).domain(genres); // Boje za žanrove

        // Priprema podataka za stacked bar chart
        var preparedData = genres.map(genre => {
            var genreData = { genre: genre };
            selectedYears.forEach(year => {
                genreData[year] = data.filter(d => d.Year == year && d.Genre.trim() == genre).length;
            });
            return genreData;
        });

        // Dimenzije grafikona
        var margin = { top: 40, right: 150, bottom: 40, left: 80 },
            width = 1000 - margin.left - margin.right,
            height = 350 - margin.top - margin.bottom;

        // Y skala (Žanrovi)
        var y = d3.scaleBand()
            .domain(genres)
            .range([0, height])
            .padding(0.1);

        // X skala (Broj knjiga)
        var x = d3.scaleLinear()
            .domain([0, d3.max(preparedData, d => d3.sum(selectedYears.map(year => d[year])))])
            .nice()
            .range([0, width]);

        // Kreiranje SVG elementa
        var svg = d3.select("#books-div1").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Kreiranje stack layouta
        var stack = d3.stack()
            .keys(selectedYears)
            .order(d3.stackOrderNone)
            .offset(d3.stackOffsetNone);

        var series = stack(preparedData);

        var customColors = ['#FAC55A', '#DF832F', '#D2611A', '#C44004', '#9D4410', '#76491C', '#4E4D27', '#275233', '#00563F'];

        var colorMap = {};
        preparedData.forEach(function(d, i) {
            colorMap[d.genre] = customColors[i % customColors.length];
        });

        var colorScale = d3.scaleOrdinal()
            .domain(genres)
            .range(genres.map(function(d) { return colorMap[d]; }));
        // Stvaranje stacked bars
        var groups = svg.selectAll(".series")
            .data(series)
            .enter().append("g")
            .attr("class", "series")
            .style("fill", (d, i) => colorScale(d.key));

        groups.selectAll("rect")
            .data(d => d)
            .enter().append("rect")
            .attr("y", d => y(d.data.genre))
            .attr("x", d => x(d[0]))
            .attr("height", y.bandwidth())
            .attr("width", d => x(d[1]) - x(d[0]));

        // Dodavanje Y osi (Žanrovi)
        svg.append("g")
            .attr("class", "y axis")
            .call(d3.axisLeft(y));

        // Dodavanje X osi (Broj knjiga)
        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x));

        // Dodavanje legende
        var legend = svg.selectAll(".legend")
            .data(selectedYears)
            .enter().append("g")
            .attr("class", "legend")
            .attr("transform", (d, i) => "translate(0," + i * 20 + ")");

        legend.append("rect")
            .attr("x", width + 20)
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", (d, i) => colorScale(d));

        legend.append("text")
            .attr("x", width + 44)
            .attr("y", 9)
            .attr("dy", ".35em")
            .style("text-anchor", "start")
            .text(d => d);

        svg.append("text")
            .attr("x", width / 2)
            .attr("y", "-10px")
            .attr("text-anchor", "middle")  
            .attr("font-weight", "600")
            .attr("font-size", "1.4em")
            .text("Genres Read by Year");
    });
}


    function showBooksByMonth(month, year) {
      d3.csv("books.csv").then(function(data) {
        d3.select("#books-div").selectAll("*").remove();
        if (!year) {
          return;
        }

        if(month==1){month = "01";}
        if(month==2){month = "02";}
        if(month==3){month = "03";}
        if(month==4){month = "04";}
        if(month==5){month = "05";}
        if(month==6){month = "06";}
        if(month==7){month = "07";}
        if(month==8){month = "08";}
        if(month==9){month = "09";}

        var filteredData = data.filter(function(d) {
            var dateParts = d.DateRead.split("/");
            return +dateParts[1] == month && +dateParts[0] == year;
        });

        var booksDiv = document.getElementById("books-div");

        var bookMonthP = document.createElement("p");
        bookMonthP.setAttribute("id", "books-month");
        booksDiv.appendChild(bookMonthP);

        var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        bookMonthP.textContent = "Books read in " + monthNames[month - 1] + " " + year;
        console.log(bookMonthP);

        var bookListDiv = document.createElement("div");
        bookListDiv.setAttribute("id", "books-list-div");
        booksDiv.appendChild(bookListDiv); 

        var booksList = document.createElement("ul");
        booksList.setAttribute("id", "books-list");
        bookListDiv.appendChild(booksList);

        var bookRating = document.createElement("ul");
        bookRating.setAttribute("id", "books-rating");
        bookListDiv.appendChild(bookRating);

        booksList.innerHTML = ""; 
        filteredData.forEach(function(book) {
            var listItem = document.createElement("li");
            listItem.textContent = book.Title;
            
            listItem.addEventListener("click", function() {
                showBookRating(book);
            });
            booksList.appendChild(listItem);
        });
      });
    }

    function showBooksByYear(year) {
    d3.csv("books.csv").then(function(data) {
        d3.select("#books-div").selectAll("*").remove();
        if (!year) {
            return;
        }

        var filteredData = data.filter(function(d) {
            var dateParts = d.DateRead.split("/");
            return +dateParts[0] === year;
        });

        var booksDiv = document.getElementById("books-div");

        var bookYearP = document.createElement("p");
        bookYearP.setAttribute("id", "books-year");
        booksDiv.appendChild(bookYearP);

        bookYearP.innerText = "Books read in " + year;

        var bookListDiv = document.createElement("div");
        bookListDiv.setAttribute("id", "books-list-div");
        booksDiv.appendChild(bookListDiv);

        var booksList = document.createElement("ul");
        booksList.setAttribute("id", "books-list");
        bookListDiv.appendChild(booksList);

        var bookRating = document.createElement("ul");
        bookRating.setAttribute("id", "books-rating");
        bookListDiv.appendChild(bookRating);

        filteredData.forEach(function(book) {
            var listItem = document.createElement("li");
            listItem.innerText = book.Title;

            listItem.addEventListener("click", function() {
                showBookRating(book);
            });
            booksList.appendChild(listItem);
        });
    });
}

    function showBookRating(book) {
        var ratingDiv = document.getElementById("books-rating");
        ratingDiv.innerHTML = ""; // Čišćenje prethodnog sadržaja

        var ratingTitle = document.createElement("p");
        ratingTitle.setAttribute("id", "title");
        ratingTitle.textContent = book.Title;
        ratingDiv.appendChild(ratingTitle);

        var ratingAuthor = document.createElement("p");
        ratingAuthor.setAttribute("id", "author");
        ratingAuthor.textContent = book.Author;
        ratingDiv.appendChild(ratingAuthor);

        var ratingImage = document.createElement("img");
        ratingImage.src = "images/stars" + book.MyRating + ".png";
        ratingImage.alt = "Rating: " + book.MyRating;
        ratingDiv.appendChild(ratingImage);
    }

    function showTotalPagesReadByYear(years) {
      d3.csv("books.csv").then(function(data) {
        d3.select("#total-pages").selectAll("*").remove();
        if (!years) return; 

        var totalPageCount = 0;

          if (Array.isArray(years)) {
              years.forEach(function(year) {
                  var filteredData = data.filter(function(d) {
                      return +d.Year === year;
                  });

                  var pageCount = d3.sum(filteredData, function(d) {
                      return +d.NumberOfPages;
                  });

                  totalPageCount += pageCount;
              });
          } else {
              var filteredData = data.filter(function(d) {
                  return +d.Year === years;
              });

              totalPageCount = d3.sum(filteredData, function(d) {
                  return +d.NumberOfPages;
              });
          }
            var totalPagesDiv = document.getElementById("total-pages");
            var totalPagesP = document.createElement("p");
            totalPagesP.setAttribute("id", "total-pages-p");
            totalPagesDiv.appendChild(totalPagesP);
            totalPagesP.textContent = "Total pages read:"

            var totalPagesSpan = document.createElement("span");
            totalPagesSpan.setAttribute("id", "total-pages-span");
            totalPagesDiv.appendChild(totalPagesSpan);

            var i = 0;
            var interval = setInterval(function() {
                totalPagesSpan.textContent = i;
                if(totalPageCount > 2500 && totalPageCount <= 5000){
                    i = i + 40;
                }
                else if(totalPageCount > 5000 && totalPageCount <= 7500){
                    i = i + 60;
                }
                else if(totalPageCount > 7500 && totalPageCount <= 10000){
                    i = i + 75;
                }
                else if(totalPageCount > 10000 && totalPageCount <= 20000){
                    i = i + 150;
                }
                else if(totalPageCount < 2500){
                    i = i + 20;
                }
                else{
                    i = i + 200;
                }
                if (i > totalPageCount) {
                    totalPagesSpan.textContent = totalPageCount;
                    clearInterval(interval); // Zaustavljanje intervala kada i dostigne totalPageCount
                }
            }, 1);
        });
    }

    var selectedYears = [];

    // Pokretanje funkcije za crtanje grafikona kada se klikne na godinu
    document.addEventListener("DOMContentLoaded", function() {
      var container = document.createElement("div");
      container.setAttribute("id", "container");
      document.body.appendChild(container);

      var box = document.createElement("div");
      box.setAttribute("id", "box");
      container.appendChild(box);

      var charts = document.createElement("div");
      charts.setAttribute("id", "charts");
      container.appendChild(charts);

      var charts1 = document.createElement("div");
      charts1.setAttribute("id", "charts1");
      charts.appendChild(charts1);

      var chartDiv = document.createElement("div"); //barchart
      chartDiv.setAttribute("id", "chart");
      charts1.appendChild(chartDiv);

      var pieChartDiv = document.createElement("div"); //piechart
      pieChartDiv.setAttribute("id", "pie-chart");
      charts1.appendChild(pieChartDiv);

      var charts2 = document.createElement("div");
      charts2.setAttribute("id", "charts2");
      charts.appendChild(charts2);

      var booksDiv1 = document.createElement("div");
      booksDiv1.setAttribute("id", "books-div1");
      charts2.appendChild(booksDiv1);

      var booksDiv = document.createElement("div");
      booksDiv.setAttribute("id", "books-div");
      charts2.appendChild(booksDiv);

      var donutChartDiv = document.createElement("div");
      donutChartDiv.setAttribute("id", "donut-chart");
      charts2.appendChild(donutChartDiv);

      var totalPagesDivParent = document.createElement("div");
      totalPagesDivParent.setAttribute("id", "total-pages-parent");
      charts2.appendChild(totalPagesDivParent);

      var totalPagesDiv = document.createElement("div");
      totalPagesDiv.setAttribute("id", "total-pages");
      totalPagesDivParent.appendChild(totalPagesDiv);

      document.getElementById("books-div1").classList.add("hidden");
      document.getElementById("books-div").classList.add("hidden");
      document.getElementById("total-pages-parent").classList.add("hidden");

      var years = [2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024]; 
      years.forEach(function(year) {
        var link = document.createElement("a");
        link.setAttribute("href", "#");
        link.textContent = year + " ";


        link.addEventListener("click", function(event) {
            event.preventDefault(); 
            var isSelected = link.style.backgroundColor === "darkseagreen";
            if (isSelected) {
                link.style.backgroundColor = "";
                var index = selectedYears.indexOf(year);
                selectedYears.splice(index, 1);
            } else {
                link.style.backgroundColor = "darkseagreen";
                selectedYears.push(year);
            }
            if (selectedYears.length === 1) {
                drawChart(selectedYears[0]);
                drawPieChart(selectedYears[0]);
                drawDonutChart(selectedYears[0]);
                showTotalPagesReadByYear(selectedYears[0]);
                showBooksByYear(selectedYears[0]);
                document.getElementById("books-div1").classList.add("hidden");
                document.getElementById("books-div").classList.remove("hidden");
                document.getElementById("total-pages-parent").classList.remove("hidden");
            } else {
                drawComparisonChart(selectedYears);
                showTotalPagesReadByYear(selectedYears);
                drawStackedHorizontalBarChart(selectedYears);
                drawBooksPieChart(selectedYears);
            }

            if (selectedYears.length === 0) {
                document.getElementById("books-div1").classList.add("hidden");
                document.getElementById("books-div").classList.add("hidden");
                document.getElementById("total-pages-parent").classList.add("hidden");
            } else if(selectedYears.length > 1) {
                document.getElementById("books-div").classList.add("hidden");
                document.getElementById("books-div1").classList.remove("hidden");
                document.getElementById("total-pages-parent").classList.remove("hidden");
            }
        });
        box.appendChild(link);
      });      
    });
  </script>
</body>
</html>
